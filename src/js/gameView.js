class gameView {
  
  constructor() {
    this.desktopAnimation = [
      [
        { left: "29.2%", top: " 22%" },
        { left: "29.2%", top: " 32%" },
        { leftt: "29.2%", top: " 41.5%" },
        { left: "29.2%", top: " 51.5%" },
        { leftt: "29.2%", top: " 61.2%" },
        { left: "29.2%", top: " 71%" },
      ],
      [
        { left: "35.4%", top: " 22%" },
        { left: "35.4%", top: " 32%" },
        { left: "35.4%", top: " 41.5%" },
        { left: "35.4%", top: " 51.5%" },
        { left: "35.4%", top: " 61.2%" },
        { left: "35.4%", top: " 71%" },
      ],
      [
        { left: "41.4%", top: " 22%" },
        { left: "41.4%", top: " 32%" },
        { leftt: "41.4%", top: " 41.5%" },
        { left: "41.4%", top: " 51.5%" },
        { left: "41.4%", top: " 61.2%" },
        { left: "41.4%", top: " 71%" },
      ],
      [
        { left: "47.4%", top: " 22%" },
        { left: "47.4%", top: " 32%" },
        { left: "47.4%", top: " 41.5%" },
        { left: "47.4%", top: " 51.5%" },
        { left: "47.4%", top: " 61.2%" },
        { left: "47.4%", top: " 71%" },
      ],
      [
        { left: "53.7%", top: " 22%" },
        { left: "53.7%", top: " 32%" },
        { leftt: "53.7%", top: " 41.5%" },
        { left: "53.7%", top: " 51.5%" },
        { left: "53.7%", top: " 61.2%" },
        { left: "53.7%", top: " 71%" },
      ],
      [
        { left: "59.7%", top: " 22%" },
        { left: "59.7%", top: " 32%" },
        { left: "59.7%", top: " 41.5%" },
        { left: "59.7%", top: " 51.5%" },
        { left: "59.7%", top: " 61.2%" },
        { left: "59.7%", top: " 71%" },
      ],
      [
        { left: "65.9%", Top: " 22%" },
        { left: "65.9%", top: " 32%" },
        { left: "65.9%", top: " 41.5%" },
        { left: "65.9%", top: " 51.5%" },
        { leftt: "65.9%", top: " 61.2%" },
        { left: "65.9%", top: " 71%" },
      ],
    ];
    
    this.tabletAnimation = [
      [
        { left: "12.2%", top: " 31.5%" },
        { left: "12.2%", top: " 40.1%" },
        { left: "12.2%", top: " 49%" },
        { left: "12.2%", top: " 57.5%" },
        { left: "12.2%", top: " 66.2%" },
        { left: "12.2%", top: "75%" },
      ],
      [
        { left: "23.7%", top: " 31.5%" },
        { left: "23.7%", top: " 40.1%" },
        { left: "23.7%", top: " 49%" },
        { left: "23.7%", top: " 57.5%" },
        { left: "23.7%", top: " 66.2%" },
        { left: "23.7%", top: "75%" },
      ],
      [
        { leftt: "35.2%", top: " 31.5%" },
        { leftt: "35.2%", top: " 40.1%" },
        { leftt: "35.2%", top: " 49%" },
        { leftt: "35.2%", top: " 57.5%" },
        { leftt: "35.2%", top: " 66.2%" },
        { leftt: "35.2%", top: "75%" },
      ],
      [
        { left: "46.5%", top: " 31.5%" },
        { left: "46.5%", top: " 40.1%" },
        { left: "46.5%", top: " 49%" },
        { left: "46.5%", top: " 57.5%" },
        { left: "46.5%", top: " 66.2%" },
        { left: "46.5%", top: "75%" },
      ],
      [
        { left: "58.1%", top: " 31.5%" },
        { left: "58.1%", top: " 40.1%" },
        { left: "58.1%", top: " 49%" },
        { left: "58.1%", top: " 57.5%" },
        { left: "58.1%", top: " 66.2%" },
        { left: "58.1%", top: "75%" },
      ],
      [
        { left: "69.5%", top: " 31.5%" },
        { left: "69.5%", top: " 40.1%" },
        { left: "69.5%", top: " 49%" },
        { left: "69.5%", top: " 57.5%" },
        { left: "69.5%", top: " 66.2%" },
        { left: "69.5%", top: "75%" },
      ],
      [
        { left: "80.9%", top: " 31.5%" },
        { left: "80.9%", top: " 40.1%" },
        { left: "80.9%", top: " 49%" },
        { left: "80.9%", top: " 57.5%" },
        { left: "80.9%", top: " 66.2%" },
        { left: "80.9%", top: "75%" },
      ],
    ];
    
    this.mobileAnimation = [
      [
        { left: "6.5%", top: " 35.8%" },
        { left: "6.5%", top: " 41.8%" },
        { leftt: "6.5%", top: " 47.3%" },
        { left: "6.5%", top: " 53.3%" },
        { leftt: "6.5%", top: " 59.1%" },
        { leftt: "6.5%", top: " 64.8%" },
      ],
      [
        { left: "19.5%", top: " 35.8%" },
        { left: "19.5%", top: " 41.8%" },
        { left: "19.5%", top: " 47.3%" },
        { left: "19.5%", top: " 53.3%" },
        { left: "19.5%", top: " 59.1%" },
        { left: "19.5%", top: " 64.8%" },
      ],
      [
        { left: "31.5%", top: " 35.8%" },
        { left: "31.5%", top: " 41.8%" },
        { left: "31.5%", top: " 47.3%" },
        { left: "31.5%", top: " 53.3%" },
        { left: "31.5%", top: " 59.1%" },
        { left: "31.5%", top: " 64.8%" },
      ],
      [
        { left: "44.5%", top: " 35.8%" },
        { left: "44.5%", top: " 41.8%" },
        { left: "44.5%", top: " 47.3%" },
        { left: "44.5%", top: " 53.3%" },
        { left: "44.5%", top: " 59.1%" },
        { left: "44.5%", top: " 64.8%" },
      ],
      [
        { left: "56.5%", top: " 35.8%" },
        { left: "56.5%", top: " 41.8%" },
        { left: "56.5%", top: " 47.3%" },
        { left: "56.5%", top: " 53.3%" },
        { left: "56.5%", top: " 59.1%" },
        { left: "56.5%", top: " 64.8%" },
      ],
      [
        { left: "69.2%", top: " 35.8%" },
        { left: "69.2%", top: " 41.8%" },
        { left: "69.2%", top: " 47.3%" },
        { left: "69.2%", top: " 53.3%" },
        { left: "69.2%", top: " 59.1%" },
        { left: "69.2%", top: " 64.8%" },
      ],
      [
        { left: "81.5%", top: " 35.8%" },
        { left: "81.5%", top: " 41.8%" },
        { left: "81.5%", top: " 47.3%" },
        { left: "81.5%", top: " 53.3%" },
        { left: "81.5%", top: " 59.1%" },
        { left: "81.5%", top: " 64.8%" },
      ],
    ];
    this.desktopMarker = [
      "420px",
      "510px",
      "600px",
      "690px",
      "770px",
      "860px",
      "950px",
    ];
    this.mobileMarker = [
      "25px",
      "75px",
      "120px",
      "170px",
      "215px",
      "260px",
      "310px",
    ];
    this.tabletMarker = [
      "95px",
      "185px",
      "270px",
      "355px",
      "450px",
      "540px",
      "630px",
    ];
    this.large = document.getElementById("counter");
    this.small = document.getElementById("counter1");
    this.game = document.getElementsByClassName("flex-conter-board");
    this.board = document.getElementById("3");
    this.markers = document.querySelectorAll(".markers div");
    this.markerRedSmall = document.querySelector(".marker-red-small");
    this.markerRedLarge = document.querySelector(".marker-red-large");
    this.markerYellowSmall = document.querySelector(".marker-yellow-small");
    this.markerYellowLarge = document.querySelector(".marker-yellow-large");
    this.gameboard = document.querySelector(".game-container");
    this.screen = document.querySelector(".screen");
    this.gameResult = document.querySelector(".game-result");
    this.turn = document.querySelector(".turn-red");
    this.drops = document.querySelectorAll(".droppoint");
    this.counters = document.querySelectorAll(".counters div");
    this.countersMobile = document.querySelector(".game-counters .mobile");
    this.countersTablet = document.querySelector(".game-counters .tablet");
    this.countersDesktop = document.querySelector(".game-counters .desktop");
    this.countersMobileAll = document.querySelectorAll(".counters .mobile");
    this.countersTabletAll = document.querySelectorAll(".counters .tablet");
    this.countersDesktopAll = document.querySelectorAll(".counters .desktop");
    this.MobileAllCounters = document.querySelectorAll(".counters .mobile div");
    this.MobileAllRed = document.querySelectorAll(
      ".counters .mobile .counter-red-small"
    );
    this.MobileAllYellow = document.querySelectorAll(
      ".counters .mobile .counter-yellow-small"
    );
    this.TabletAllCounters = document.querySelectorAll(".counters .tablet div");
    this.TabletAllRed = document.querySelectorAll(
      ".counters .tablet .counter-red-large"
    );
    this.TabletAllYellow = document.querySelectorAll(
      ".counters .tablet .counter-yellow-large"
    );
    this.DesktopAllCounters = document.querySelectorAll(
      ".counters .desktop div"
    );
    this.DesktopAllRed = Array.from(
      document.querySelectorAll(".counters .desktop .counter-red-large")
    );
    this.DesktopAllYellow = Array.from(
      document.querySelectorAll(".counters .desktop .counter-yellow-large")
    );
    
    this.activeEvent = "";
    this.originalX = "";
    this.originalY = "";
    const self = this;
  }

  animate(element, frames) {
    if (frames.length === 1) {
      frames.push(frames[0]);
    }
    element.animate(frames, {
      duration: 500,
      iterations: 1,
      fill: "forwards",
    });
  }

  checkScreenSize() {
    let screen = "";

    if (window.matchMedia("(max-width: 767px)").matches) {
      screen = "mobile";
    }
    if (
      window.matchMedia("(min-width: 768px) and (max-width: 1439px)").matches
    ) {
      screen = "tablet";
    }
    if (window.matchMedia("(min-width: 1440px)").matches) {
      screen = "desktop";
    }

    return screen;
  }

  setDisplayCounters(counters) {
    counters.forEach((item) => {
      item.display = none;
    });
  }

  animateOnScreen(element, frameNumber) {
    console.log(this);
    switch (this.checkScreenSize()) {
      case "mobile":
        this.animate(element, this.mobileAnimation[frameNumber]);
        this.savePlayerMove(element, this.mobileAnimation[frameNumber], frameNumber);
        break;
      case "tablet":
        this.animate(element, this.tabletAnimation[frameNumber]);
        this.savePlayerMove(element, this.tabletAnimation[frameNumber], frameNumber);
        break;
      case "desktop":
        this.animate(element, this.desktopAnimation[frameNumber]);
        this.savePlayerMove(element, this.desktopAnimation[frameNumber], frameNumber);
        break;
    }
    setCounterPosition(element, frameNumber);
  }

  setCounterPosition(element, frameNumber) {
    let desktop = desktopAnimation[frameNumber].pop();
    let tablet = tabletAnimation[frameNumber].pop();
    let mobile = mobileAnimation[frameNumber].pop();
    const prefix = ["desktop", "tablet", "mobile"];
    let elementNumber = element.id.split("#")[1];
    prefix.forEach((item) => {
      let name = item + "#" + elementNumber;
      let newElement = document.getElementById(name.toString());
      switch (item) {
        case "desktop":
          newElement.style.left = desktop.left;
          newElement.style.top = desktop.top;
          moveCounterToGameBoard(newElement, "desktop");
          break;
        case "tablet":
          newElement.style.left = tablet.left;
          newElement.style.top = tablet.top;
          moveCounterToGameBoard(newElement, "tablet");
          break;
        case "mobile":
          newElement.style.left = mobile.left;
          newElement.style.top = mobile.top;
          moveCounterToGameBoard(newElement, "mobile");
          break;
      }
    });
  }

  moveCounterToGameBoard(element, boardElement) {
    let board = document.querySelector(".game-counters ." + boardElement);
    board.appendChild(element);
  }
  addListeners() {
    this.drops.forEach((droppoint) => {
      droppoint.addEventListener("dragenter", this.dragEnter.bind(this));
      droppoint.addEventListener("dragover", this.dragOver.bind(this));
      droppoint.addEventListener("dragleave", this.dragLeave.bind(this));
      droppoint.addEventListener("drop", this.drop.bind(this));
    });
    this.counters.forEach((counter) => {
      counter.addEventListener("dragstart", this.dragStart.bind(this));
      counter.addEventListener("touchstart", this.TouchStart.bind(this));
      counter.addEventListener("touchmove", this.TouchMove.bind(this));
      counter.addEventListener("touchend", this.TouchEnd.bind(this));
    });

   
  }

  detectTouchEnd(pageX, pageY, width) {
    let scrollTop = window.pageYOffset;
    let currentDrop = null;
    drops.forEach((current) => {
      if (
        parseInt(pageX) + width / 2 > current.getBoundingClientRect().left &&
        parseInt(pageX) + width / 2 < current.getBoundingClientRect().right &&
        parseInt(pageY) + width / 2 > current.getBoundingClientRect().top &&
        parseInt(pageY) + width / 2 <
          current.getBoundingClientRect().bottom + scrollTop
      ) {
        currentDrop = current;
      }
    });
    return currentDrop;
  }

  showMarker(color, target) {
    
    let markerSmall = this.markerRedSmall;
    let markerLarge = this.markerRedLarge;
    if (color === "yellow") {
      markerSmall = this.markerYellowSmall;
      markerLarge = this.markerYellowLarge;
    }

    if (this.checkScreenSize() === "mobile") {
      markerSmall.style.position = "absolute";
      markerSmall.style.left = this.mobileMarker[target];
      markerSmall.style.top = "230px";
      markerSmall.style.display = "block";
    } else if (this.checkScreenSize() === "tablet") {
      markerLarge.style.position = "absolute";
      markerLarge.style.left = this.tabletMarker[target];
      markerLarge.style.top = "230px";
      markerLarge.style.display = "block";
    } else if (this.checkScreenSize() === "desktop") {
      markerLarge.style.position = "absolute";
      markerLarge.style.left = this.desktopMarker[target];
      markerLarge.style.top = "100px";
      markerLarge.style.display = "block";
    }
  }

  respondForMove(color) {
    if (this.checkWinner(color)) {
      turn.style.display = "none";
      gameResult.style.display = "block";
    } else {
      color === "red" ? (color = "yellow") : (color = "red");
      this.changeTurn(color);
    }
  }

  hideAllMarkes() {
    this.markers.forEach((marker) => {
      this.marker.style.display = "none";
    });
  }

  savePlayerMove(element, animationFrameArr, position) {
    gameArray[animationFrameArr.length - 1][position] =
      this.getCounterColor(element);
  }

  getCounterColor(element) {
    return element.id.split("-")[1];
  }

  changeTurn(color) {
    if (color === "red") {
      this.turn.style.backgroundImage =
        "url('../assets/images/turn-background-red.svg')";
      this.turn.textContent = "Player 1's turn";
    } else {
      this.turn.style.backgroundImage =
        "url('../assets/images/turn-background-yellow.svg')";
      this.turn.textContent = "Player 2's turn";
    }
  }

  runGame() {
    gameResult.style.display = "none";
  }

  dragStart(e) {
    e.dataTransfer.setData("text/plain", e.target.id);
  }

  dragEnter(e) {
    e.preventDefault();

    let color = e.dataTransfer.getData("text/plain").split("-")[1];
    let target = e.target.id;
   
    this.showMarker(color, target);
  }

  dragOver(e) {
    e.preventDefault();
  }

  dragLeave(e) {
    e.preventDefault();
  }

  drop(e) {
    const id = e.dataTransfer.getData("text/plain");
    const dragElement = document.getElementById(id);
    let color =this.getCounterColor(dragElement);
    this.animateOnScreen(dragElement, parseInt(e.target.id));

    this.respondForMove(color);
  }

  TouchStart(e) {
    this.originalX = e.target.offsetLeft + "px";
    this.originalY = e.target.offsetTop + "px";
    this.hideAllMarkes();
    this.activeEvent = "start";
  }

  TouchMove(e) {
    e.preventDefault();
    let width = parseInt(window.getComputedStyle(e.target).width);
    let touchLocation = e.targetTouches[0];

    let color = touchLocation.target.id.split("-")[1];
    let pageX = touchLocation.pageX - 50 + "px";
    let pageY = touchLocation.pageY - 50 + "px";
    e.target.style.zIndex = 100;
    e.target.style.position = "absolute";
    e.target.style.left = pageX;
    e.target.style.top = pageY;

    activeEvent = "move";
    if (this.detectTouchEnd(pageX, pageY, width) != null) {
      let current = self.detectTouchEnd(pageX, pageY, width);
      this.showMarker(color, current.id);
    }
  }

  TouchEnd(e) {
    e.preventDefault();
    e.stopImmediatePropagation();
    let element = e.target;
    if (activeEvent === "move") {
      let pageX = parseInt(e.target.style.left);
      let pageY = parseInt(e.target.style.top);
      let width = parseInt(window.getComputedStyle(e.target).width);
      element.style.zIndex = 10;

      if (this.detectTouchEnd(pageX, pageY, width) != null) {
        let current = this.detectTouchEnd(pageX, pageY, width);
        this.animateOnScreen(element, parseInt(current.id));
      } else {
        e.target.style.left = originalX;
        e.target.style.top = originalY;
      }
    }
    let color = this.getCounterColor(element);
    this.respondForMove(color);
  }

 
}




